# PDF Upload & Weaviate Integration - Setup Guide

## Overview
The system now supports PDF uploads on the intake form. When users upload one or more PDF files, the backend extracts text, generates an embedding query using OpenAI's reasoning API, and queries the Weaviate vector database for the top 5 similar cases.

## What Was Changed

### Backend (app.py)
- **New endpoint**: `/api/upload-case` (POST)
  - Accepts multiple PDF files via multipart/form-data
  - Extracts text from all PDFs using pypdf
  - Combines extracted text and generates a query using OpenAI reasoning
  - Queries Weaviate with `top_k=5`
  - Returns formatted case results

### Frontend Updates

#### Case Intake Form (`frontend/app/(dashboard)/intake/_components/case-intake-form.tsx`)
- Updated file upload handler to only accept PDF files
- Modified submit handler to:
  - Send PDFs to `/api/upload-case` endpoint
  - Store results in localStorage
  - Navigate to cases page with real data

#### Similar Cases Results (`frontend/app/(dashboard)/cases/_components/similar-cases-results.tsx`)
- Updated to first check localStorage for data from PDF upload
- Maps Weaviate response format to the expected CaseData format
- Falls back to mock API if no PDF data is available

### Dependencies (requirements.txt)
Added:
- `pypdf==5.1.0` - For PDF text extraction
- `weaviate-client==4.9.3` - For vector database queries

## Setup Instructions

1. **Install Python dependencies**:
   ```bash
   cd /Users/jporbeck/Desktop/Repos/Hackathon/Hackathon/legal_strategy_platform
   source venv/bin/activate
   pip install -r requirements.txt
   ```

2. **Ensure environment variables are set**:
   Make sure your `.env` file contains:
   ```
   WEAVIATE_URL=your_weaviate_url
   WEAVIATE_API_KEY=your_weaviate_api_key
   OPENAI_API_KEY=your_openai_api_key
   ```

3. **Start the Flask backend**:
   ```bash
   python app.py
   ```
   The backend will run on `http://localhost:5000`

4. **Start the Next.js frontend** (in a separate terminal):
   ```bash
   cd frontend
   npm run dev
   ```
   The frontend will run on `http://localhost:3000`

## How to Test

1. Navigate to `http://localhost:3000/intake`
2. Fill in the case information (optional fields)
3. **Upload one or more PDF files** (drag & drop or click to browse)
   - Only PDF files are accepted
   - Multiple files can be uploaded
4. Click "Analyze Case & Find Similar Cases"
5. The system will:
   - Extract text from the PDFs
   - Generate a semantic query using OpenAI
   - Search Weaviate for the top 5 similar cases
   - Display results on the `/cases` page

## Data Flow

```
PDF Upload → Text Extraction → Query Generation → Weaviate Search → Results Display
```

1. **PDF Upload**: User uploads PDF(s) on `/intake`
2. **Text Extraction**: Backend extracts all text from PDFs using pypdf
3. **Query Generation**: Combined text is sent to OpenAI reasoning API to generate a semantic query
4. **Weaviate Search**: Query is used to search the vector database (top_k=5)
5. **Results Storage**: Results are stored in localStorage
6. **Display**: Results are shown on `/cases` page with distance and certainty scores

## API Response Format

The `/api/upload-case` endpoint returns:

```json
{
  "success": true,
  "cases": [
    {
      "rank": 1,
      "case_id": "10583350",
      "uuid": "1580f6a4-f879-49b0-b703-adad0e0637b6",
      "title": "State v. Rochon",
      "body": "Trial court's decision to deny limited driving privileges...",
      "source_file": "filtered_reckless_driving_cases.json",
      "distance": 0.43681633472442627,
      "certainty": 0.7815918326377869,
      "absolute_url": "/opinion/10583350/state-v-rochon/",
      "judge": "Mayle",
      "metadata": {
        "court": "Ohio Court of Appeals",
        "dateFiled": "2025-05-13"
      }
    }
    // ... 4 more cases
  ],
  "extracted_text": "First 500 characters of extracted text...",
  "query": "Generated semantic query..."
}
```

## LocalStorage Keys

The following data is stored in localStorage:
- `similarCases`: Array of case objects from Weaviate
- `extractedText`: First 500 characters of extracted PDF text
- `generatedQuery`: The semantic query generated by OpenAI
- `legalCase`: The full case intake form data
- `selectedCases`: Cases selected by user for strategy generation

## Troubleshooting

### "PDF processing library not installed"
- Run: `pip install pypdf`

### "Failed to connect to backend server"
- Ensure Flask is running on port 5000
- Check CORS settings in app.py

### "No text could be extracted from the uploaded PDFs"
- Verify PDFs are not image-only (scanned documents)
- Try a different PDF with selectable text

### Weaviate connection errors
- Verify WEAVIATE_URL and WEAVIATE_API_KEY in .env
- Check that the collection "RecklessDisorderlyMock" exists
- Verify network connectivity to Weaviate instance

## Configuration

The Weaviate search is configured in `config.yaml`:
- Collection name: `RecklessDisorderlyMock`
- Vectorizer: `text2vec-openai`
- Embedding model: `text-embedding-3-large`
- Top K: Set to **5** in the code (as requested)
- Distance and certainty metrics: Enabled

## Next Steps

The similar cases found via PDF upload can now be used in the strategy synthesis workflow. Selected cases are passed to the `/api/generate-strategies` endpoint for AI-powered strategy generation.

